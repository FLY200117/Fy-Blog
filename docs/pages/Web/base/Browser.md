# 浏览器

[[toc]]





## 浏览器的构成

浏览器的核心主要是两部分：浏览器内核（渲染引擎）和JavaScript引擎。

而浏览器内核有下面这几种：

| 内核名称          | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| Trident（IE）     | 是国内双核浏览器的内核之一，此内核只能用于Window平台，且不是开源 |
| Webkit（Safari）  | 曾经Chrome的内核，其本身是包含渲染引擎和JS引擎的，严格意义上不算内核 |
| Gecko（FF）       | 火狐开源内核，跨平台，支持Win，Linux，Mac                    |
| Chromium（谷歌）  | 作为曾经Chrome的开源内核，Electron就是根据该内核开发的       |
| Blink（谷歌现用） | Chromium —— Webkit —— Blink，作为谷歌最新的内核，弥补了前两者的很多不足 |



## 浏览器的运行原理

渲染引擎和JS引擎相互工作，渲染引擎会解析服务器发送过来的html文件，在以往的单进程浏览器中，解析的过程是单进程的，所以在解析js代码的时候就需要将渲染控制权交给js引擎来处理，但是后面出现的双进程甚至是多进程浏览器中，就能解决以前单进程浏览器的不稳定，不流畅，不安全。事实上，无论是在浏览器中还是在node中执行js代码，最后都是需要被CPU执行的

浏览器进程只有一个，浏览器的每个tab页面都是一个单线程，



渲染引擎处理页面时，通常分为四个阶段：

1. 解析代码：HTML代码解析为DOM tree，CSS代码解析为CSS rule
2. 对象合成：将DOM tree和CSS rule相结合形成render tree
3. 布局：计算出渲染树的布局（Layout）
4. 绘制：将渲染内容渲染到屏幕上（Painting）



![渲染引擎工作图](/images/browser/render.png)



::: tip

注意上面的步骤并不是严格按顺序执行的，有时候页面没有解析完全时就已经开始第二第三步了，所以在浏览器上的内容并不是一下子全部加载出来的

:::



而JS引擎主要负责解析，执行js代码，在浏览器解析html文件时，如果遇到`script`标签，就会先暂停解析，将网页渲染控制权转交给JS引擎，如果script有引用外部脚本，则下载脚本，当JS引擎执行完毕时，会将控制权交还给渲染引擎，恢复解析过程。加载完的js文件往往会被浏览器进行缓存

常见的js引擎有：

+ SpiderMonkey
+ Chakra
+ JavaScriptCore
+ **V8(主流)**



## V8引擎

js引擎是一种为了解析和执行JavaScript代码而设计的[虚拟机](https://baike.baidu.com/item/%E8%99%9A%E6%8B%9F%E6%9C%BA/104440)，一般js引擎会包含以下部分：

1. 编译器，主要将源代码编译成抽象语法树或者字节码
2. 解释器，主要解释执行字节码，依赖垃圾回收机制
3. JIT工具，将字节码或抽象语法树转换成本地代码
4. 垃圾回收器和分析工具，负责垃圾回收和收集引擎中的信息，改善引擎的性能



::: tip

JavaScript是单线程语言，但是浏览器是多进程，浏览器的单个页面中是一个线程执行js代码

:::



V8是用C ++编写的Google开源高性能JavaScript和WebAssembly引擎，它用于Chrome和Node.js等，V8可以独立运行，也可以嵌入到任何C ++应用程序中。**V8的主要工作就是将js代码转换成机器码**





V8引擎的运行过程：

+ 首先通过解析器将JavaScript解析成AST
+ 然后解释器会将AST翻译成字节码。此阶段边解释边执行。同时解释器会记录特定代码段的执行次数，当运行次数达到一定值「称为阈值」，解释器就会将该段代码标记为热代码，并将信息反馈给优化编译器
+ 优化编译器会对标记的代码段进行优化，最终生成优化后的字节码。这样当该段代码需要再次执行时，就会直接使用优化后的机器码执行，不用再进行解释编译。从而大大提高代码运行效率







## JS代码的具体解析过程

